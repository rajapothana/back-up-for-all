/*
** Copyright Â© 2018 Apple Inc.
** All rights reserved.
*/

its.kit.createController("iTSProductRating",{binding:"div.customer-ratings",component:{init:function(){var e=this.element;
this.isInline=e.getAttribute("data-inline-review")=="true",this.initialRating=e.getAttribute("data-initial-rating"),this.didClick=!1,this.isApp=document.body.hasClassName("software");
var t=this.staticRating=e.querySelector("div.customer-ratings > div.rating"),n=this.widget=e.querySelector("div.rate-stars");
this.noRating=t===null;
if(t)this.descStatic=t.querySelector("span.rating-desc"),this.listen(this.staticRating,"mouseover"),this.listen(this.staticRating,"mouseout"),this.listen(this.widget,"mouseout");
else{var r=n.parentByTagName("label");
r&&this.listen(r,"mouseout")}var i=this.stars=n.querySelectorAll("span:not(.rating-desc)");
this.desc=n.querySelector("span.rating-desc"),this.listen(this.desc,"mouseover"),i.each(function(e){this.listen(e,"mouseover"),this.listen(e,"mouseout"),this.listen(e,"click")},this),this.descArray=["Js.InlineReview.1","Js.InlineReview.2","Js.InlineReview.3","Js.InlineReview.4","Js.InlineReview.5"].map(its.loc),this.descText=this.desc.innerHTML,this.histograms=e.querySelectorAll("div.ratings-histogram"),this.isApp&&this.histograms[0]&&this.histograms[0].addClassName("open"),this.histograms.each(function(e){var t=e.querySelector("a");
t.addEventListener("click",function(t){t.preventDefault(),e.toggleClassName("open")},!1)}),this.setCurrentRating(),window.iTSBuyButton&&this.listen(document,iTSBuyButton.Events.BUY_SUCCEEDED,"buyListener")},buyListener:function(e){its.client.log("We had a buy event. Clearing out error message."),this.element.removeClassName("error")},clickEvent:function(e){var t=e.currentTarget,n=t.getAttribute("star-count");
its.client.screenReaderRunning()&&n&&(this.showStars(n.toInt()),this.desc.innerHTML=this.descArray[n-1]);
var r=t.parentNode.querySelectorAll("span[star-count]");
for(i=r.length-1;
i>=0;
i--)r[i].setAttribute("aria-checked","false");
t.setAttribute("aria-checked","true");
if(t&&t.hasClassName("star")){var s=its.client.getUserDSID();
s?this.setStarRating(n):its.client.authenticate(bind(this,"setStarRating",n),its.loc("Js.InlineRating.SigninTitle"),its.loc("Js.InlineRating.SigninMessage"))}},mouseoverEvent:function(e){var t=this.stars.toArray().indexOf(e.currentTarget);
e.currentTarget===this.staticRating?(this.staticRating.hide(),this.widget.show(),this.staticRating.removeEventListener("mouseover",this,!1)):e.currentTarget==this.desc?this.setCurrentRating():(this.showStars(t+1),this.desc.innerHTML=its.loc(this.descArray[t]))},mouseoutEvent:function(e){this.didItLeave(e),e.fromElement!==this.element&&(this.desc.innerHTML=this.descText),this.setCurrentRating()},didItLeave:function(e){if(!e.toElement||e.toElement==this.widget||e.toElement.parentByClassName("rate-stars"))return;!this.isInline&&!this.noRating&&!this.didClick&&(this.widget.hide(),this.staticRating.show(),this.listen(this.staticRating,"mouseover"))},showStars:function(e){for(var t=4;
t>=0;
t--)t>=e?this.stars[t].removeClassName("star"):this.stars[t].addClassName("star")},setCurrentRating:function(){var e=this.widget.getAttribute("current-rating"),t=e?e:this.initialRating;
this.showStars(t||0);
var n="";
n==0?n=this.descStatic:n=this.descArray[t-1],n&&this.isInline&&(this.desc.innerHTML=n,this.descText=n)},setStarRating:function(e){its.notifications.publish("/iTSProductRating/ratingEvent",{count:e}),this.widget.setAttribute("current-rating",e),this.didClick=!0;
if(this.isInline){var t=document.querySelector("input[name=rating]");
t.value=e}else{var n=this.widget.getAttribute("rating-url")+"&rating="+e,r={};
its.client.isRunning&&iTunes.getMachineGUID&&(r.desktopGuid=iTunes.getMachineGUID()),iTSInclude.makeHttpRequest({url:n,timeout:2e4,formParams:r,successCallback:bindAsEventListener(this,"successHandler",e),failureCallback:bindAsEventListener(this,"failureHandler",e),checkForDialog:!1})}},successHandler:function(e,t){if(its.isXMLResponse(e)){if(/ADD_USER_REVIEW_RATING_PURCHASE_REQUIRED/.test(e.responseText)){this.element.addClassName("error");
return}this.failureHandler(e,t);
return}this.descText=its.loc("Js.InlineReview.Thanks"),this.desc.innerHTML=this.descText,this.descStatic&&(this.descStatic.innerHTML=this.descText)},failureHandler:function(e,t){this.reviewSubmitEnabled=!0,/authorization/.test(e.responseText)?its.client.authenticate(bind(this,"setStarRating",t),its.loc("Js.InlineRating.SigninTitle"),its.loc("Js.InlineRating.SigninMessage")):(this.descText=its.loc("Js.InlineReview.Error"),this.desc.innerHTML=this.descText,this.descStatic&&(this.descStatic.innerHTML=this.descText))}}}),its.kit.createController("iTSCustomerReview",{binding:"div.customer-review:not(.new-review)",component:{init:function(){var e=this.element;
this.rate=e.querySelector("p.feedback span.rate, .connection-options .connection-rate, .helpful-wrapper .rate");
if(!this.rate){console.log("Unable to locate rate component");
return}this.connectionRating=this.rate.hasClassName("connection-rate"),this.report=e.querySelector("h5 > a.report, .connection-options .reportConcern"),this.voteLinkEnabled=!0,this.voteURL=this.rate.getAttribute("content"),this.reviewerDsid=this.rate.getAttribute("reviewer-dsid"),this.userDsid=its.client.getUserDSID();
var t=its.client.isPingParentalControlPreferenceEnabled&&its.client.isPingParentalControlPreferenceEnabled();
this.connectionRating&&(this.reviewerDsid==this.userDsid||t===!1)&&(this.voteLinkEnabled=!1);
var n=this.rate.querySelectorAll("a.helpful-vote");
n.each(function(e){this.connectionRating&&t===!1?e.parentNode.removeChild(e):this.voteLinkEnabled?(e.immedatelyLikeable=this.rate.getAttribute("immedately-likeable")=="true",this.listen(e,"click",this)):e.addClassName("disabled-review-action")},this),this.postReview=e.querySelector(".connection-options .postReview"),this.postReview&&(t===!0?this.listen(this.postReview,"click",this):t===!1?this.postReview.parentNode.removeChild(this.postReview):this.postReview.addClassName("disabled-review-action"));
if(this.connectionRating&&t===!1){var r=e.querySelector(".user-info a.report");
r&&(r.href="javascript:void(0)");
var i=e.querySelector(".connection-options > span.dot");
i&&i.parentNode.removeChild(i)}},handleEvent:function(e){if(e.type!="click")return;var t=e.currentTarget,n=t.getAttribute("vote");
n?(e.preventDefault(),this.voteLinkEnabled&&this[this.connectionRating?"likeHandler":"submitReviewVote"](n,t.immedatelyLikeable)):t.getAttribute("post-url")&&this.postReviewHandler(e)},postReviewHandler:function(e){this.verifySignIn(its.loc("CNConnections.Dialog.Post.Review.SignIn.Title"),its.loc("CNConnections.Dialog.Post.Review.SignIn.Message"),bind(this,"postTheReview",e))},postTheReview:function(e){function t(t){return e.currentTarget.getAttribute(t)}if(!this.verifyOptIn()){this.confirmOptIn();
return}if(its.cn.isLoggedInUserPrivate()){its.cn.alertNotSupportedIfPrivate();
return}var n=this.element,r=n.querySelector(".content"),i=r!=null?r.innerHTML:"",s=n.querySelector(".customerReview-title");
s==null&&(s=n.querySelector(".title-text"));
var o=s!=null?s.innerHTML:"No Title";
(new iTSCNPostContentDialog({type:"PostReview",dialogUrl:t("dialog-url"),localizeTokens:{displayName:t("display-name")},postUrl:t("post-url"),postParams:{action:"Review",albumId:t("content-adam-id"),reviewId:t("review-id"),reviewDsid:t("reviewer-dsid"),reviewerNickname:t("reviewer-name"),reviewTitle:o,reviewBody:i,rating:t("rating")}})).open()},submitReviewVote:function(e){var t={vote:e};
its.client.isRunning&&iTunes.getMachineGUID&&(t.desktopGuid=iTunes.getMachineGUID()),iTSInclude.makeHttpRequest({url:this.voteURL,element:this.rate,successCallback:this.connectionRating?bind(this,"reviewSuccessHandler"):function(){},failureCallback:null,timeout:1e4,formParams:t,checkForDialog:!0})},reviewSuccessHandler:function(e){var t=this.element.querySelector(".connection-rate"),n=t.getAttribute("vote-plus-one");
t.innerHTML=n},authenticate:function(e,t,n,r){var i={okButtonAction:function(e){e==1?n():r?r():alert("Failed to authenticate. Please try again later.")}},s={kind:"authorization",defaultButton:"ok",message:e,explanation:t,okButtonString:its.loc("CNConnections.Dialog.OptIn.ButtonSignIn"),cancelButtonString:its.loc("Cancel")};
its.client.showDialog(s,i)},verifySignIn:function(e,t,n){var r=its.client.getUserDSID();
r?n():this.authenticate(e,t,n)},verifyOptIn:function(){var e=document.body.getAttribute("cn-cookie-name")||"mz_at1",t=its.cookies.get(e),n=its.client.getUserDSID();
return n&&t},verifyOptInAndVote:function(e,t){t||this.verifyOptIn()?its.cn.isLoggedInUserPrivate()?its.cn.confirmLeakyActionIfPrivate(bind(this,"submitReviewVote",e)):this.submitReviewVote(e):this.confirmOptIn()},confirmOptIn:function(){var e={okButtonAction:bind(this,function(){this.gotoConnectionsOptIn()})},t={defaultButton:"ok",message:its.loc("CNConnections.Dialog.OptIn.Title"),explanation:its.loc("CNConnections.Dialog.OptIn.Message"),cancelButtonString:its.loc("CNConnections.Dialog.OptIn.ButtonCancel"),okButtonString:its.loc("CNConnections.Dialog.OptIn.ButtonSubmit")};
its.client.showDialog(t,e)},likeHandler:function(e,t){this.verifySignIn(its.loc("CNConnections.Dialog.Like.Review.SignIn.Title"),its.loc("CNConnections.Dialog.Like.Review.SignIn.Message"),bind(this,"verifyOptInAndVote",e,t))},gotoConnectionsOptIn:function(){var e=document.body.querySelectorAll(".customer-reviews"),t=null;
for(var n=0,r=e.length,i;
n<r;
n++){t=e[n].getAttribute("opt-into-connections-url");
if(t)break}t?its.url.formRedirect("ping",t):this.unknownHandler("Unknown")},unknownHandler:function(e){its.client.showDialog({message:its.loc("Js.iTunesStoreError.Message",{errorNum:e}),explanation:its.loc("Js.iTunesStoreError.Explanation",{errorNum:e}),defaultButton:"ok",okButtonString:its.loc("Ok")})}}}),its.kit.createController("iTSCustomerReviewsList",{binding:"div.customer-reviews",component:{init:function(){var e=this.element;
this.currentVersionButton=e.querySelector("div.pill button:first-child"),this.allVersionsButton=e.querySelector("div.pill button:nth-child(2)"),this.currentVersionList=e.querySelector("div.current-reviews"),this.allVersionsList=e.querySelector("div.all-reviews"),this.previousVersionsButton=e.querySelector("a.previous-reviews-link"),this.currentVersionButton&&this.listen(this.currentVersionButton,"click","showCurrentVersion"),this.allVersionsButton&&this.listen(this.allVersionsButton,"click","showAllVersions"),this.previousVersionsButton&&this.listen(this.previousVersionsButton,"click","showAllVersions")},showCurrentVersion:function(e){e.preventDefault(),this.allVersionsList.style.display="none",this.currentVersionList.style.display="block",this.currentVersionButton.addClassName("active"),this.allVersionsButton.removeClassName("active")},showAllVersions:function(e){e.preventDefault(),this.allVersionsList.style.display="block",this.currentVersionList.style.display="none",this.currentVersionButton.removeClassName("active"),this.allVersionsButton.addClassName("active"),its.kit.sendToController("SfTextTruncate","rebind")}}}),its.kit.createController("iTSReportAConcern",{binding:".report-a-concern",component:{init:function(){this.link=this.element.querySelector("a"),this.link&&this.link.addEventListener("click",bind(this,this.clickEvent),!1)},clickEvent:function(e){e.preventDefault();
var t=its.client.getUserDSID();
t?this.showRACDialog():its.client.authenticate(bind(this,"showRACDialog"),its.loc("Js.ReportAConcern.SigninTitle"),its.loc("Js.ReportAConcern.SigninMessage"))},showRACDialog:function(){var e=this.element.getAttribute("report-a-concern-fragment-url"),t=function(){var e=this.form=document.querySelector(".report-a-concern-form");
e&&(e.addEventListener("submit",bind(this,"processSubmit"),!1),this.submitButton=e.querySelector(".submit-handler"),this.submitButton&&(this.submitButton.disabled=!0),this.reasonSelect=e.querySelector(".select-stack select"),this.reasonSelect&&this.reasonSelect.addEventListener("change",bind(this,"processUserInput"),!1),this.commentText=e.querySelector(".report-a-concern-content"),this.commentText&&this.commentText.addEventListener("keyup",bind(this,"processUserInput"),!1),this.close=e.querySelector(".close-handler"),this.close.addEventListener("click",bind(this,function(e){e.preventDefault(),this.dialog.close()}),!1)),this.dialog.focus()},n=function(e){return its.isXMLResponse(e)?(this.dialog&&(this.dialog.close(),this.dialog=null),/authorization/.test(e.responseText)?its.client.authenticate(bind(this,"showRACDialog"),its.loc("Js.ReportAConcern.SigninTitle"),its.loc("Js.ReportAConcern.SigninMessage")):its.client.showPlistErrorDialog(e),!1):!0};
this.dialog=new iTSDialog({className:"report-a-concern-dialog",showCloseIcon:!0,contentUrl:e,onLoadCb:bind(this,t),onPreRenderCallback:bind(this,n)}),this.dialog.open()},hasSelectedReason:function(e){return e.value!=="0"},hasUserText:function(e){return e.value.replace(/\s/g,"")},processUserInput:function(e){var t=this.submitButton;
if(!e.target||!t)return;this.hasSelectedReason(this.reasonSelect)&&this.hasUserText(this.commentText)?(t.disabled=!1,t.removeClassName("disabled")):(t.disabled=!0,t.addClassName("disabled"))},processSubmit:function(e){e.preventDefault();
var t=this.form,n={userReview:t.querySelector(".user-review-id").value,selectedReason:t.querySelector(".select-stack .select select").value,explanation:t.querySelector(".report-a-concern-content").value};
its.client.isRunning&&iTunes.getMachineGUID&&(n.desktopGuid=iTunes.getMachineGUID()),iTSInclude.makeHttpRequest({method:"post",url:t.getAttribute("submit-url"),successCallback:bind(this,"successHandler"),failureHandler:bind(this,"failureHandler"),timeout:3e4,formParams:n})},successHandler:function(e){var t=this.form;
if(!t||!e.responseText)return;if(its.isXMLResponse(e))its.client.showPlistErrorDialog(e);
else{t.innerHTML=e.responseText;
var n=t.querySelector(".close-handler");
n&&n.addEventListener("click",bind(this,function(e){e.preventDefault(),this.dialog.close()}),!1)}},failureHandler:function(e){its.client.showGenericErrorAlert()}}}),its.kit.createController("iTSInlineReview",{binding:"div.customer-reviews",component:{init:function(){var e=this.element;
this.writeLink=e.querySelectorAll("div.write-a-review a.write-a-review-link"),this.inlineContainer=e.querySelector(".inline-review"),this.inlineContainer&&(this.contentURL=this.inlineContainer.getAttribute("content"),this.writeLinkEnabled=!0,this.reviewSubmitEnabled=!0),this.writeLink&&this.inlineContainer&&(this.writeLink.addEventListeners("click",this,!1),this.listen(this.inlineContainer,"webkitTransitionEnd",this));
var t=window.location.href,n=/showReviewForm=true/ig;
if(t.indexOf("#")>=0&&n.test(t)){var r=t.replace(n,"");
this.contentURL&&(this.showMeTheReview(function(){this.element.scrollIntoView()}),window.history&&window.history.replaceState({},document.title,r),window.location.href=r)}window.iTSBuyButton&&document.addEventListener(iTSBuyButton.Events.BUY_SUCCEEDED,bind(this,"buyListener"))},buyListener:function(e){its.client.log("We had a buy event. Enabling reviews.");
var t=this.element.querySelectorAll("div.write-a-review");
t.each(function(e){e.removeClassName("error")}),this.writeLinkEnabled=!0,this.writeLink.show()},showMeTheReview:function(e){var t=its.client.getUserDSID();
t?this.showReviewFormInclude(e):its.client.authenticate(bind(this,"showReviewFormInclude",e),its.loc("Js.InlineReview.SigninTitle"),its.loc("Js.InlineReview.SigninMessage"))},handleEvent:function(e){switch(e.type){case"click":e.preventDefault(),this.writeLinkEnabled&&this.showMeTheReview();
break;case"webkitTransitionEnd":this.isCancel||(this.reviewForm.style.opacity="1");
break;case"keyup":this.charCount(this.reviewField,this.reviewCount,6e3);
break;case"reset":this.reviewSubmitEnabled&&this.hideReviewForm();
break;case"submit":e.preventDefault(),this.reviewSubmitEnabled&&this.showSuccessFormInclude(!0)}},verifyOptIn:function(){var e=document.body.getAttribute("cn-cookie-name")||"mz_at1",t=its.cookies.get(e);
return t?!0:!1},showReviewFormInclude:function(e){this.writeLinkEnabled=!1;
var t=bindAsEventListener(this,function(t){if(its.isXMLResponse(t)){if(/ADD_USER_REVIEW_RATING_PURCHASE_REQUIRED/.test(t.responseText)){var n=this.element.querySelectorAll("div.write-a-review");
n.each(function(e){e.addClassName("error")})}else this.failureHandler(t,this.showReviewFormInclude.bind(this));
return}this.inlineContainer.innerHTML=t.responseText,this.showReviewForm(t,!0),e&&e()}),n=bindAsEventListener(this,"failureHandler",this.showReviewFormInclude);
iTSInclude.makeHttpRequest({url:this.contentURL,successCallback:t,failureCallback:n,timeout:1e4,formParams:null})},showSuccessFormInclude:function(e){this.reviewSubmitEnabled=!1,this.submitButton.disabled=!0,this.submitButton.addClassName("disabled"),iTSInclude.makeHttpRequest({url:this.submitUrl,checkForDialog:!0,element:this.inlineContainer,successCallback:bindAsEventListener(this,"showReviewSuccess",e),failureCallback:bindAsEventListener(this,"failureHandler"),timeout:1e4,formParams:this.formValues()})},showReviewForm:function(e,t){window.reviewWindowIsOpen=!0;
if(its.client.platformIsDA){this.renderForm(t);
return}this.verifyOptIn()&&its.cn.isLoggedInUserPrivate()?its.cn.confirmLeakyActionIfPrivate(bind(this,"renderForm",!1),bind(this,"cancelRender",!1)):this.renderForm(t)},cancelRender:function(){this.writeLinkEnabled=!0},renderForm:function(e){this.inlineContainer.removeClassName("success"),this.submitButton=this.inlineContainer.querySelector("#submit-review");
var t=this;
its.notifications.subscribe("/iTSProductRating/ratingEvent",function(){if(!t.submitButton)return;t.submitButton.disabled=!1,t.submitButton.removeClassName("disabled")}),this.submitButton.disabled=!0,this.submitButton.addClassName("disabled"),this.innerBox=this.element.querySelector(".inline-review > div"),this.reviewForm=this.inlineContainer.querySelector("form"),this.submitUrl=this.reviewForm.getAttribute("action"),this.reviewField=this.reviewForm.querySelector("textarea"),this.reviewCount=this.reviewForm.querySelector("span.review-count"),this.listen(this.reviewForm,"reset",this),this.listen(this.reviewForm,"submit",this),e?this.innerBox.style.webkitTransition="height 0.3s ease-out":this.reviewForm.style.opacity="1",this.inlineContainer.setAttribute("data-inline-review","true"),this.inlineContainer.setAttribute("data-initial-rating",document.querySelector("input[name=rating]").value),this.inlineContainer.setAttribute("ignore-plists","true"),this.ratingStars=new iTSProductRating,this.ratingStars.element=this.inlineContainer,this.ratingStars.init(),this.isCancel=!1,this.writeLinkEnabled=!0,this.writeLink.hide(),this.innerBox.show(),this.charCountInit(),this.updateForFormErrors(),e?defer(this,function(){this.innerBox.style.height=this.reviewForm.offsetHeight+25+"px"}):this.innerBox.style.height=this.reviewForm.offsetHeight+25+"px",this.element.querySelector("div.title").removeClassName("hidden")},updateSubmitButton:function(){!this.titleError&&!this.nickNameError&&!this.reviewError&&(this.submitButton.disabled=!1,this.submitButton.removeClassName("disabled"))},updateForFormErrors:function(){this.submitButton=this.inlineContainer.querySelector("#submit-review"),this.titleError=this.inlineContainer.querySelector(".title .error"),this.nickNameError=this.inlineContainer.querySelector(".nickname .error"),this.reviewError=this.inlineContainer.querySelector(".review .error");
var e=this,t=this.inlineContainer.querySelector(".title .review-field");
t.addEventListener("keyup",function(t){e.titleError&&(e.titleError.style.visibility="hidden",e.titleError=null),e.updateSubmitButton()},!1);
var n=this.inlineContainer.querySelector(".nickname .review-field");
n&&n.addEventListener("keyup",function(t){e.nickNameError&&(e.nickNameError.style.visibility="hidden",e.nickNameError=null),e.updateSubmitButton()},!1);
var r=this.inlineContainer.querySelector(".review .review-field");
r.addEventListener("keyup",function(t){e.reviewError&&(e.reviewError.style.visibility="hidden",e.reviewError=null),e.updateSubmitButton()},!1)},showReviewSuccess:function(e,t){if(its.isXMLResponse(e)){this.failureHandler(e);
return}this.reviewSubmitEnabled=!0;
if(this.inlineContainer.querySelector("form"))this.showReviewForm(e,!1),this.updateForFormErrors();
else{this.inlineContainer.addClassName("success"),this.editButton=this.inlineContainer.querySelector("button#edit-review"),this.listen(this.editButton,"click",this);
if(its.client.screenReaderRunning()){var n=this.inlineContainer.querySelector("h5");
n&&n.focus()}its.kit.sendToController("ItsDtDynamicPageController","forceUserInfoRefresh")}},hideReviewForm:function(){this.innerBox.style.webkitTransition="height 0.3s ease-out",this.isCancel=!0,this.reviewForm.style.opacity="0";
var e=this;
setTimeout(function(){e.innerBox.style.height="0px",e.innerBox.hide(),e.writeLink.show(),its.client.screenReaderRunning()&&e.writeLink.focus()},0),window.reviewWindowIsOpen=!1,this.element.querySelector("div.title").addClassName("hidden")},charCountInit:function(){this.reviewField.addEventListener("keydown",this,!1),this.reviewField.addEventListener("keyup",this,!1),this.charCount(this.reviewField,this.reviewCount,6e3)},charCount:function(e,t,n){e.value.length>n?e.value=e.value.substring(0,n):t.innerHTML=n-e.value.length},formValues:function(){var e=document.querySelector('form[name="product-review"]'),t={};
return e&&e.elements.each(function(e){e.name&&e.value&&(t[e.name]=e.value)}),its.client.isRunning&&iTunes.getMachineGUID&&(t.desktopGuid=iTunes.getMachineGUID()),t},failureHandler:function(e,t){this.reviewSubmitEnabled=!0,/authorization/.test(e.responseText)&&t?its.client.authenticate(t,its.loc("Js.InlineReview.SigninTitle"),its.loc("Js.InlineReview.SigninMessage")):its.client.showPlistErrorDialog(e)}}})